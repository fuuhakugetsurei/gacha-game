<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>極限抽卡模擬器 - 邏輯改良版</title>
    <style>
        :root {
            --rarity-ssr: linear-gradient(135deg, #ffcc33, #ff6600);
            --rarity-sr: linear-gradient(135deg, #cc66ff, #6600ff);
            --rarity-r: linear-gradient(135deg, #33ccff, #0066ff);
            --gold-glow: 0 0 30px #ffcc33, 0 0 60px #ff6600;
            --special-glow: 0 0 30px #00ffcc, 0 0 60px #00ff88;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            background: #050505; font-family: 'PingFang TC', sans-serif; color: white;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; z-index: 1; }

        .main-layout {
            position: relative; z-index: 10;
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            height: 100vh;
            width: 100vw;
        }

        /* 左側：卡池選單 */
        .pool-selector {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px; display: flex; flex-direction: column;
        }

        .pool-item {
            padding: 15px; margin-bottom: 10px; border-radius: 10px;
            background: rgba(255,255,255,0.05); cursor: pointer;
            transition: 0.3s; border: 1px solid transparent;
            display: flex; justify-content: space-between; align-items: center;
        }
        .pool-item.active { background: rgba(99,102,241,0.2); border-color: #6366f1; }
        .pool-item.special-pool { border-color: #00ffcc; background: rgba(0, 255, 204, 0.1); }
        .pool-item:hover { background: rgba(255,255,255,0.1); }
        .del-pool { color: #ff4d4d; font-weight: bold; padding: 5px; }

        /* 中間：召喚區 */
        .summon-stage {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .pool-title-display { font-size: 3rem; font-weight: 200; letter-spacing: 15px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        .pity-counter { font-size: 0.9rem; color: #888; margin-bottom: 40px; letter-spacing: 2px; }

        .ticket-status {
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 50px;
            margin-bottom: 20px; border: 1px solid rgba(0, 255, 204, 0.4);
            font-size: 14px; color: #00ffcc;
        }

        .summon-btn {
            background: none; border: 1px solid #fff; color: #fff;
            padding: 20px 60px; font-size: 24px; letter-spacing: 5px;
            cursor: pointer; transition: 0.3s; border-radius: 5px;
        }
        .summon-btn:hover:not(:disabled) { background: #fff; color: #000; box-shadow: 0 0 40px rgba(255,255,255,0.6); }
        .summon-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; }

        /* 右側：編輯區與紀錄 */
        .editor-sidebar {
            background: rgba(0,0,0,0.6); backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255,255,255,0.1); padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }

        input, textarea {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #444;
            color: white; border-radius: 5px; padding: 10px; box-sizing: border-box; margin-bottom: 15px;
        }

        .history-panel {
            margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;
        }
        .history-list {
            list-style: none; padding: 0; margin: 0; font-size: 13px;
        }
        .history-item {
            padding: 8px 10px; margin-bottom: 5px; background: rgba(255,255,255,0.03);
            border-radius: 4px; display: flex; justify-content: space-between;
        }
        .color-ssr { color: #ffcc33; text-shadow: 0 0 5px rgba(255,102,0,0.5); }
        .color-sr { color: #cc66ff; }
        .color-r { color: #33ccff; }

        /* 抽卡場景 */
        #gacha-scene {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center;
            z-index: 100; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
        }
        .card-container { width: 300px; height: 450px; perspective: 1000px; text-align: center; }
        .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.17, 0.88, 0.32, 1.27); cursor: pointer; }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-front { background: #111; border: 2px solid #333; }
        .card-back { transform: rotateY(180deg); color: #000; padding: 20px; box-sizing: border-box; }
        .rarity-badge { background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 50px; font-weight: bold; margin-bottom: 20px; }
        
        #close-btn {
            position: absolute; bottom: -80px; left: 50%; transform: translateX(-50%);
            background: white; color: black; border: none; padding: 12px 40px;
            border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 16px;
            display: none; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            white-space: nowrap; z-index: 101;
        }

        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 200; pointer-events: none; }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div class="main-layout">
        <div class="pool-selector">
            <h3 style="letter-spacing: 2px;">召喚卡池</h3>
            <div id="pool-list" style="flex-grow: 1; overflow-y: auto;"></div>
            <button onclick="createNewPool()" style="width:100%; padding:10px; cursor:pointer; background:#6366f1; border:none; color:white; border-radius:5px;">+ 新增卡池</button>
        </div>

        <div class="summon-stage">
            <div id="pool-display-name" class="pool-title-display">載入中...</div>
            <div class="ticket-status" id="ticket-info">集點進度: 0/10 | 特殊抽卡券: 0</div>
            <div id="pity-info" class="pity-counter">目前累計：0 抽</div>
            <button id="main-summon-btn" class="summon-btn" onclick="startGacha()">進行召喚</button>
        </div>

        <div class="editor-sidebar">
            <div id="editor-ui">
                <h3>池子設定</h3>
                <label id="label-pool-name">卡池名稱</label>
                <input type="text" id="edit-pool-name" oninput="updateCurrentPoolInfo()">
                <label id="label-pool-content">獎勵內容</label>
                <textarea id="edit-pool-content" style="height: 150px;" oninput="updateCurrentPoolInfo()"></textarea>
                <button id="save-btn" onclick="saveAllToStorage()" style="width:100%; padding:10px; background:#222; border:1px solid #555; color:white; cursor:pointer; border-radius:5px;">儲存設定</button>
                <button id="reset-pity-btn" onclick="resetPity()" style="width:100%; padding:8px; background:transparent; border:1px solid #ff4d4d; color:#ff4d4d; cursor:pointer; margin-top:10px; border-radius:5px; font-size: 12px;">重置保底</button>
            </div>

            <div class="history-panel">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0">召喚紀錄</h3>
                    <button onclick="clearHistory()" style="background:none; border:none; color:#888; cursor:pointer; font-size:12px;">清除</button>
                </div>
                <div id="history-list-container" class="history-list"></div>
            </div>
        </div>
    </div>

    <div id="gacha-scene">
        <div class="card-container">
            <div class="card" id="main-card" onclick="flipCard()">
                <div class="card-face card-front">
                    <div style="font-size: 60px;">✦</div>
                    <p style="opacity:0.5">點擊揭曉</p>
                </div>
                <div class="card-face card-back" id="card-result">
                    <div class="rarity-badge" id="rarity-tag">SSR</div>
                    <h2 id="reward-name">獎項名稱</h2>
                </div>
            </div>
            <button id="close-btn" onclick="closeScene()">確認收下</button>
        </div>
    </div>

    <div class="flash" id="flash"></div>

    <script>
        // --- 背景效果 (略) ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        class Particle { constructor() { this.reset(); } reset() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2; this.speedY = -Math.random() * 0.5; } update() { this.y += this.speedY; if (this.y < 0) this.reset(); } draw() { ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); } }
        for(let i=0; i<60; i++) particles.push(new Particle());
        function animate() { ctx.fillStyle = '#050505'; ctx.fillRect(0,0,canvas.width, canvas.height); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
        animate();

        // --- 全域數據 ---
        let globalData = JSON.parse(localStorage.getItem('gachaGlobalV8')) || { nonSsrCount: 0, specialTickets: 0 };
        let allPools = JSON.parse(localStorage.getItem('gachaSystemV8')) || [
            { id: 'special', name: "✨ 特殊輪盤", content: "獎勵A\n獎勵B\n獎勵C", pity: 0, history: [], isFixed: true },
            { id: 'normal_1', name: "常駐召喚", content: "SSR: 英雄劍 @2 !80\nSR: 騎士盾 @15 !20\nR: 藥草", pity: 0, history: [] }
        ];

        let currentPoolIdx = 0;

        function renderPoolList() {
            const list = document.getElementById('pool-list');
            list.innerHTML = "";
            allPools.forEach((pool, idx) => {
                const div = document.createElement('div');
                div.className = `pool-item ${idx === currentPoolIdx ? 'active' : ''} ${pool.isFixed ? 'special-pool' : ''}`;
                div.innerHTML = `<span onclick="switchPool(${idx})" style="flex-grow:1">${pool.name}</span>${pool.isFixed ? '' : `<span class="del-pool" onclick="deletePool(${idx}, event)">×</span>`}`;
                list.appendChild(div);
            });
            
            const p = allPools[currentPoolIdx];
            document.getElementById('pool-display-name').innerText = p.name;
            document.getElementById('edit-pool-name').value = p.name;
            document.getElementById('edit-pool-content').value = p.content;

            // 針對特殊池隱藏保底重置按鈕
            document.getElementById('reset-pity-btn').style.display = p.isFixed ? "none" : "block";
            document.getElementById('edit-pool-name').disabled = p.isFixed;
            
            updateUIStatus();
            renderHistory();
        }

        function updateUIStatus() {
            const p = allPools[currentPoolIdx];
            const btn = document.getElementById('main-summon-btn');
            document.getElementById('ticket-info').innerText = `集點進度: ${globalData.nonSsrCount}/10 | 特殊抽卡券: ${globalData.specialTickets}`;
            document.getElementById('pity-info').innerText = p.isFixed ? "特殊輪盤：消耗1張券，獎率均分" : `目前累計：${p.pity || 0} 抽`;
            
            if(p.isFixed && globalData.specialTickets <= 0) {
                btn.disabled = true; btn.innerText = "需要特殊抽卡券";
            } else {
                btn.disabled = false; btn.innerText = "進行召喚";
            }
        }

        function switchPool(idx) { currentPoolIdx = idx; renderPoolList(); }
        function createNewPool() {
            allPools.push({ id: Date.now().toString(), name: "新卡池", content: "SSR: 大獎 @1 !100\nR: 沒中", pity: 0, history: [] });
            currentPoolIdx = allPools.length - 1;
            renderPoolList(); saveAllToStorage();
        }
        function deletePool(idx, e) {
            e.stopPropagation(); if(confirm("確定刪除？")) { allPools.splice(idx, 1); currentPoolIdx = 0; renderPoolList(); saveAllToStorage(); }
        }
        function updateCurrentPoolInfo() {
            allPools[currentPoolIdx].name = document.getElementById('edit-pool-name').value;
            allPools[currentPoolIdx].content = document.getElementById('edit-pool-content').value;
            if(!allPools[currentPoolIdx].isFixed) document.getElementById('pool-display-name').innerText = allPools[currentPoolIdx].name;
            renderPoolList();
        }
        function saveAllToStorage() {
            localStorage.setItem('gachaSystemV8', JSON.stringify(allPools));
            localStorage.setItem('gachaGlobalV8', JSON.stringify(globalData));
            alert("儲存成功！");
        }

        // --- 改良後的抽卡演算法 ---
        function startGacha() {
            const p = allPools[currentPoolIdx];
            if(p.isFixed) { if(globalData.specialTickets <= 0) return; globalData.specialTickets--; }

            const lines = p.content.split('\n').filter(l => l.trim() !== '');
            let rewards = [];

            if(p.isFixed) {
                // 特殊池：機率平均分配，不看標籤
                const avgProb = 100 / lines.length;
                rewards = lines.map(name => ({ rarity: 'Special', name: name.trim(), prob: avgProb }));
            } else {
                // 普通池：解析稀有度、機率、保底
                rewards = lines.filter(l => l.includes(':')).map(line => {
                    const [rarityPart, rest] = line.split(':');
                    const rarity = rarityPart.trim();
                    const prob = (rest.match(/@([\d.]+)/) || [])[1];
                    const pity = (rest.match(/!(\d+)/) || [])[1];
                    const name = rest.replace(/@[\d.]+/, '').replace(/![\d+]+/, '').trim();
                    let weight = rarity.toUpperCase().includes('SSR') ? 3 : (rarity.toUpperCase().includes('SR') ? 2 : 1);
                    return { rarity, name, prob: prob ? parseFloat(prob) : null, pityLimit: pity ? parseInt(pity) : null, weight };
                });
            }

            let finalWin = null;

            if(!p.isFixed) {
                p.pity = (p.pity || 0) + 1;
                // 改良點 1：尋找目前所有「已達成」的保底獎項
                const eligiblePities = rewards.filter(r => r.pityLimit && p.pity >= r.pityLimit);
                
                if (eligiblePities.length > 0) {
                    // 若有多個保底觸發，選最高級的
                    eligiblePities.sort((a, b) => b.weight - a.weight);
                    finalWin = eligiblePities[0];
                    
                    // 改良點 2：只有觸發最高權重(SSR)的保底，才重置總計數
                    if (finalWin.weight === 3) p.pity = 0;
                } else {
                    // 機率隨機
                    let randomVal = Math.random() * 100;
                    let currentRange = 0;
                    for (let r of rewards) {
                        if (r.prob !== null) {
                            currentRange += r.prob;
                            if (randomVal <= currentRange) { finalWin = r; break; }
                        }
                    }
                    if (!finalWin) {
                        const noProb = rewards.filter(r => r.prob === null);
                        finalWin = noProb.length > 0 ? noProb[Math.floor(Math.random()*noProb.length)] : rewards[rewards.length-1];
                    }
                    // 抽到 SSR 也要重置計數
                    if (finalWin.rarity.toUpperCase().includes('SSR')) p.pity = 0;
                }
            } else {
                // 特殊池簡單隨機
                let r = Math.random() * 100;
                let cur = 0;
                for(let item of rewards) {
                    cur += item.prob;
                    if(r <= cur) { finalWin = item; break; }
                }
            }

            // 集點進度 (普通池非 SSR)
            if(!p.isFixed && !finalWin.rarity.toUpperCase().includes('SSR')) {
                globalData.nonSsrCount++;
                if(globalData.nonSsrCount >= 10) { globalData.nonSsrCount = 0; globalData.specialTickets++; }
            }

            // 紀錄
            const now = new Date();
            p.history.push({ rarity: finalWin.rarity, name: finalWin.name, time: `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}` });
            if(p.history.length > 50) p.history.shift();

            updateUIStatus(); renderHistory();
            localStorage.setItem('gachaSystemV8', JSON.stringify(allPools));
            localStorage.setItem('gachaGlobalV8', JSON.stringify(globalData));
            showResult(finalWin, p.isFixed);
        }

        function showResult(win, isSpecial) {
            document.getElementById('reward-name').innerText = win.name;
            document.getElementById('rarity-tag').innerText = win.rarity;
            const back = document.getElementById('card-result');
            const r = win.rarity.toUpperCase();
            if(isSpecial) {
                back.style.background = 'linear-gradient(135deg, #00ffcc, #0099ff)'; back.style.boxShadow = 'var(--special-glow)';
            } else if(r.includes('SSR')) {
                back.style.background = 'var(--rarity-ssr)'; back.style.boxShadow = 'var(--gold-glow)';
            } else if(r.includes('SR')) {
                back.style.background = 'var(--rarity-sr)'; back.style.boxShadow = '0 0 30px #cc66ff';
            } else {
                back.style.background = 'var(--rarity-r)'; back.style.boxShadow = '0 0 20px #33ccff';
            }
            document.getElementById('gacha-scene').style.display = 'flex';
            document.getElementById('main-card').classList.remove('flipped');
            document.getElementById('close-btn').style.display = 'none';
            const flash = document.getElementById('flash');
            flash.style.transition = 'none'; flash.style.opacity = '1';
            setTimeout(() => { flash.style.transition = 'opacity 0.8s'; flash.style.opacity = '0'; }, 50);
        }

        function renderHistory() {
            const container = document.getElementById('history-list-container');
            const p = allPools[currentPoolIdx];
            container.innerHTML = p.history.length === 0 ? '<div style="color:#444;text-align:center;padding:10px">無紀錄</div>' : '';
            [...p.history].reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                let r = item.rarity.toUpperCase();
                let c = r.includes('SSR') ? 'color-ssr' : (r.includes('SR') ? 'color-sr' : 'color-r');
                div.innerHTML = `<span class="${c}">[${item.rarity}]</span><span>${item.name}</span><span style="color:#333;font-size:10px">${item.time}</span>`;
                container.appendChild(div);
            });
        }

        function flipCard() { document.getElementById('main-card').classList.add('flipped'); setTimeout(() => { document.getElementById('close-btn').style.display = 'block'; }, 600); }
        function closeScene() { document.getElementById('gacha-scene').style.display = 'none'; }
        function resetPity() { allPools[currentPoolIdx].pity = 0; updateUIStatus(); }
        function clearHistory() { allPools[currentPoolIdx].history = []; renderHistory(); }

        renderPoolList();
    </script>
</body>
</html>